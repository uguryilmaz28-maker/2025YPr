<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’§ DSÄ° 2025 YatÄ±rÄ±m ProgramÄ±</title>
<link rel="shortcut icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ğŸ’§</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<style>
:root{--dsigreen:#0b6954;--dsigreen-2:#0f7e64;--bg:#f4f7f6;--card:#fff;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#083;font-family:"Segoe UI",system-ui,-apple-system,Arial}
header{position:sticky;top:0;z-index:10;background:var(--dsigreen);color:#fff;display:flex;align-items:center;justify-content:center;padding:10px 14px}
header h1{margin:0;font-size:1.2rem;white-space:nowrap}

/* KPI ve grafikler */
.kpi-panel{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;background:#e6f2ef;padding:10px}
.kpi{background:var(--card);border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:10px 14px;min-width:150px;text-align:center}
.kpi .t{font-size:.82rem;color:#345}.kpi .v{font-size:1.1rem;font-weight:700;color:var(--dsigreen)}
.charts{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px}.chart-box{flex:1 1 300px;max-width:380px;min-width:240px}
.chart-box{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:10px;flex:1 1 360px;max-width:420px;text-align:center}

/* Arama barÄ± */
.searchBar{background:#e6f2ef;display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:10px;padding:10px 16px;border-radius:8px;margin-top:-4px;}
.searchWrap2{display:flex;align-items:center;gap:6px;flex:1;max-width:600px;}
.searchWrap2 input{flex:1;padding:8px 12px;border:1px solid #ccd;border-radius:8px;}
#clearSearch{background:#fff;color:#0b6954;border:1px solid #ccd;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:1rem;transition:background .2s;}
#clearSearch:hover{background:#f0f7f5;}
#filterBtn{background:#fff;color:var(--dsigreen);border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}

/* Liste */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;padding:12px}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);padding:12px;cursor:pointer;transition:box-shadow .15s}
.card:hover{box-shadow:0 2px 10px rgba(0,0,0,.15)}
.card h3{color:var(--dsigreen);margin:0 0 6px}
.card p{margin:4px 0;color:#234}
.pagination{text-align:center;padding:8px 16px}
.pagination button{background:var(--dsigreen);color:#fff;border:none;margin:2px;padding:7px 10px;border-radius:8px;cursor:pointer}
.pagination button:disabled{opacity:.4;cursor:not-allowed}
.pagination .info{margin:0 8px;color:#345}

/* SaÄŸdan kayan filtre Ã§ekmecesi */
.drawer{position:fixed;top:0;right:-420px;width:380px;max-width:90vw;height:100%;background:#fff;box-shadow:-3px 0 12px rgba(0,0,0,.18);transition:right .25s ease;z-index:15;border-left:4px solid var(--dsigreen)}
.drawer.open{right:0}
.drawer header{background:#fff;color:#123;display:flex;justify-content:space-between;align-items:center;gap:6px;border-bottom:1px solid #eee;padding:10px}
.drawer h2{margin:0;font-size:1.05rem}
.drawer .body{padding:10px 12px 70px;overflow:auto;height:calc(100% - 56px)}
.drawer .actions{position:absolute;bottom:0;left:0;right:0;display:flex;gap:10px;justify-content:space-between;padding:10px;border-top:1px solid #eee;background:#fafafa}
.btn{background:var(--dsigreen);color:#fff;border:none;border-radius:8px;padding:9px 12px;cursor:pointer;font-weight:600}
.btn.secondary{background:#e7efed;color:#123}

/* Accordion + checklist */
.acc-item{border:1px solid #e8eeec;border-radius:10px;margin-bottom:10px;overflow:hidden}
.acc-head{width:100%;text-align:left;background:#f6fbf9;border:none;padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px}
.acc-head .title{font-weight:700;color:#0b6954}
.acc-head .count{margin-left:auto;background:#e6f2ef;color:#123;font-size:.8rem;border-radius:999px;padding:2px 8px}
.acc-head .car{font-size:1rem;color:#456}
.acc-panel{padding:8px 10px;border-top:1px solid #eaeaea;display:none}
.acc-item.open .acc-panel{display:block}
.checklist{display:flex;flex-direction:column;gap:4px;max-height:220px;overflow-y:auto;border:1px solid #ccd;border-radius:8px;padding:6px 8px;background:#fff;}
.chkopt{display:flex;align-items:center;justify-content:space-between;font-size:.9rem;color:#123;padding:3px 4px;border-radius:4px;transition:background .15s;}
.chkopt:hover{background:#f0f7f5;}
.chkopt input{accent-color:#0b6954;width:16px;height:16px;cursor:pointer;}

/* Detay modal (mobil uyumlu, kaydÄ±rmalÄ±) */
.modal-wrap{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:30;padding:16px}
.modal{
  display:flex;
  flex-direction:column;
  max-height:90vh;
  width:100%;
  max-width:980px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 8px 30px rgba(0,0,0,.25);
  overflow:hidden;
  animation:pop .18s ease;
}
@keyframes pop{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.modal header,.modal footer{position:sticky;background:#fff;z-index:5}
.modal header{
  top:0;background:#f0f7f5;border-bottom:1px solid #eee;
  display:flex;align-items:center;gap:10px;padding:14px 16px;
}
.modal footer{
  bottom:0;border-top:1px solid #eee;
  display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;
}
.m-body{flex:1 1 auto;min-height:0;overflow-y:auto;padding:14px 16px;}
.modal h3{margin:0;color:#000}
.m-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.m-card{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px}
.m-card .l{font-size:.8rem;color:#456}
.m-card .v{font-weight:700;color:#0b6954}
.print-hint{margin-left:auto;color:#567;font-size:.9rem}

/* === Sayfalama gÃ¶rÃ¼nÃ¼m ayarlarÄ± === */
.pagination {
  text-align: center;
  padding: 12px 16px;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  justify-content: center;
  align-items: center;
}

.pagination button {
  background: #f8fdfb;
  color: #0b6954;
  border: 1px solid #bcd2ca;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.pagination button:hover:not(:disabled) {
  background: #0b6954;
  color: #fff;
}

.pagination button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.pagination .page-numbers button {
  min-width: 32px;
  border-radius: 6px;
}

.pagination .info {
  margin-left: 10px;
  color: #345;
  font-size: 0.9rem;
}

.pagination .goto-wrap {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: 8px;
  font-size: 0.9rem;
  color: #234;
}

.pagination .goto-wrap label {
  font-weight: 500;
}

.pagination .goto-wrap input[type="number"] {
  width: 60px;
  padding: 3px 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  text-align: center;
}
.pagination .goto-wrap button {
  background: #0b6954;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 4px 10px;
  cursor: pointer;
  transition: background .15s;
}

.pagination .goto-wrap button:hover {
  background: #095b48;
}

/* YazdÄ±rma */
@media print{
  header,.kpi-panel,.charts,.toolbar,#list,#pagination,#drawer,.searchBar{display:none !important}
  .modal-wrap{display:flex !important;position:static !important;background:none !important;box-shadow:none}
  .modal{box-shadow:none;max-height:none;overflow:visible}
}
</style>
</head>
<body>
<header><h1>ğŸ’§ DSÄ° 2025 YatÄ±rÄ±m ProgramÄ±</h1></header>

<section class="kpi-panel">
  <div class="kpi"><div class="t">Toplam Maliyet</div><div class="v" id="k_maliyet">â€“</div></div>
  <div class="kpi"><div class="t">Toplam Harcama</div><div class="v" id="k_harcama">â€“</div></div>
  <div class="kpi"><div class="t">Revize Ã–denek</div><div class="v" id="k_revize">â€“</div></div>
  <div class="kpi"><div class="t">2025 YÄ±lÄ± HarcamasÄ±</div><div class="v" id="k_yiliharcama">â€“</div></div>
  <div class="kpi"><div class="t">Bakiye</div><div class="v" id="k_bakiye">â€“</div></div>
  <div class="kpi"><div class="t">2025 Performans Hedefi</div><div class="v" id="k_hedef">â€“</div></div>
  <div class="kpi"><div class="t">Sulama (ha) ToplamÄ±</div><div class="v" id="k_sulama">â€“</div></div>
</section>

<section class="charts">
  <div class="chart-box"><canvas id="barChart" height="160"></canvas></div>
  <div class="chart-box"><canvas id="donutChart" height="160"></canvas></div>
</section>

<div class="searchBar">
  <div class="searchWrap2">
    <input id="q" placeholder="Faaliyet, il, yapÄ±m ÅŸekli, baÅŸkanlÄ±k vb. araâ€¦">
    <button id="clearSearch" title="Temizle">âŒ</button>
  </div>
  <button id="filterBtn">âš™ï¸ Filtrele</button>
</div>

<div class="toolbar">
  <div class="rowsel">Sayfa boyutu:
    <select id="rowsPerPage">
      <option>50</option>
      <option selected>100</option>
      <option>150</option>
      <option>200</option>
    </select>
  </div>
</div>

<main id="list" class="grid"></main>
<div id="pagination" class="pagination"></div>

<!-- SaÄŸdan kayan filtre Ã§ekmecesi -->
<aside id="drawer" class="drawer" aria-hidden="true">
  <header>
    <h2>Filtrele</h2>
    <button id="closeDrawer" class="btn secondary">Kapat âœ•</button>
  </header>
  <div class="body" id="filterContainer"></div>
  <div class="actions">
    <button id="clearFilters" class="btn secondary">TÃ¼mÃ¼nÃ¼ Temizle</button>
    <button id="applyFilters" class="btn">Tamam</button>
  </div>
</aside>

<!-- Detay Modal -->
<div id="detailWrap" class="modal-wrap" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" id="detailModal">
    <header>
      <img src="dsi_logo.png" alt="DSÄ°" width="40" height="40">
      <div>
        <h3 id="m_title">Faaliyet</h3>
        <div id="m_sub" style="color:#456;font-size:.9rem"></div>
      </div>
      <div class="print-hint">ğŸ–¨ï¸ <b>YazdÄ±r</b> â†’ PDF kaydÄ± alabilirsiniz</div>
    </header>
    <div class="m-body">
      <div class="m-grid" id="m_grid"></div>
    </div>
    <footer>
      <button id="btnPrint" class="btn secondary">ğŸ–¨ï¸ YazdÄ±r</button>
      <button id="btnClose" class="btn">Kapat</button>
    </footer>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
const SHEET_ID="18dE07YFXAoUcLqAZ4lqCPD0XT1s_ZfwO";
const SHEET_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

const FILTER_DEFS = [
  {key:"PERFORMANS_DURUMU",label:"Performans Durumu",matches:["PERFORMANS DURUMU","PERFORMANS LÄ°STESÄ°","PERFORMANS LISTESI"]},
  {key:"DAIRE",label:"Ä°ÅŸten Sorumlu Daire",matches:["Ä°ÅTEN SORUMLU DAÄ°RE BAÅKANLIÄI"]},
  {key:"BOLGE_NO",label:"BÃ¶lge No",matches:["BÄ°RÄ°M KODU","BÃ–LGE NO"]},
  {key:"CSBB_UST",label:"CSBB Ãœst",matches:["CSBB ÃœST","CSBB UST","CSBB SEVÄ°YE ÃœST","CSBB SEVIYE UST","ÃœST PROJE","UST PROJE"]},
  {key:"YAPIM",label:"YapÄ±m Åekli",matches:["YAPIM ÅEKLÄ°","YAPIM SEKLI"]},
  {key:"FINANS",label:"Finans",matches:["FÄ°NANS","FINANS","FÄ°NANSMAN TÃœRÃœ","FINANSMAN TÃœRÃœ"]},
  {key:"BOLGESEL",label:"BÃ¶lgesel Durum",matches:["BÃ–LGESEL DURUM"]},
  {key:"HAVZA",label:"Havza AdÄ±",matches:["HAVZA ADI","HAVZA"]},
  {key:"IL",label:"Ä°l AdÄ±",matches:["Ä°L ADI","Ä°LÄ°","Ä°L "]},
];

let RAW=[], ALL=[], VIEW=[];
let PAGE=1, PAGE_SIZE=100;
let barChart=null, donutChart=null;
const memoryKey="dsi_filters_v1";

/* =================== HELPERS =================== */
function normalizeKey(k){return String(k||"").toUpperCase().trim().replace(/\s+/g," ");}

function cleanNumber(v){
  if(v==null) return 0;
  let s=String(v).trim();
  if(s.includes("%")) return parseFloat(s.replace(/[^\d.,-]/g,"").replace(",",".")||0)/100;
  s=s.replace(/[^\d.,-]/g,"");
  if(s.includes(",")&&(s.split(",")[1]||"").length<=3) s=s.replace(/\./g,"").replace(",",".");
  else s=s.replace(/\./g,"");
  const n=parseFloat(s);
  return isNaN(n)?0:n;
}
const fmt = n => cleanNumber(n).toLocaleString("tr-TR");

function findCol(row, candidates){
  const keys=Object.keys(row||{});
  for(const c of candidates){
    const C = normalizeKey(c);
    const found=keys.find(k => normalizeKey(k)===C);
    if(found) return found;
  }
  return null;
}
function findSulamaKey(sampleRow){
  const keys=Object.keys(sampleRow||{}).map(k=>normalizeKey(k));
  let idx = keys.findIndex(k => k==="SULAMA (HA)");
  if(idx>-1) return Object.keys(sampleRow)[idx];
  idx = keys.findIndex(k => k.includes("SULAMA") && k.includes("(HA"));
  if(idx>-1) return Object.keys(sampleRow)[idx];
  idx = keys.findIndex(k => k.includes("SULAMA"));
  return idx>-1 ? Object.keys(sampleRow)[idx] : null;
}

/* =================== LOAD =================== */
async function load(){
  const csv = await fetch(SHEET_URL).then(r=>r.text());
  const parsed = Papa.parse(csv,{header:true,skipEmptyLines:true});
  RAW = parsed.data || [];
  ALL = RAW.map(r=>{
    const o={}; for(const k in r){ o[k]=String(r[k]??"").trim(); }
    o.__TITLE = o["FAALÄ°YET ADI"] || o["FAALÄ°YET"] || o["BAÅLIK FAALÄ°YET"] || "-";
    return o;
  });
  buildFilterPanel();          // Accordion + checkbox
  restoreFilters();            // Ã–nceki seÃ§imleri iÅŸaretle
  applyAll();                  // Liste + KPI + grafik
}

/* =================== FILTER PANEL =================== */
function buildFilterPanel(){
  const box = document.getElementById("filterContainer");
  box.innerHTML = "";
  FILTER_DEFS.forEach(def=>{
    const sample = ALL[0]||{};
    const col = findCol(sample, def.matches);
    if(!col) return;

    const vals = Array.from(new Set(ALL.map(r=>r[col]).filter(v=>v))).sort((a,b)=>a.localeCompare(b,'tr'));

    const wrap = document.createElement("div");
    wrap.className = "acc-item";
    wrap.setAttribute("data-key", def.key);

    wrap.innerHTML = `
      <button class="acc-head" type="button">
        <span class="title">${def.label}</span>
        <span class="count" id="cnt_${def.key}" hidden>0 seÃ§ili</span>
        <span class="car">â–¾</span>
      </button>
      <div class="acc-panel">
        <div class="checklist" id="chk_${def.key}">
          ${vals.map(v=>`
            <label class="chkopt">
              <span>${v}</span>
              <input type="checkbox" value="${v}">
            </label>
          `).join("")}
        </div>
      </div>
    `;
    box.appendChild(wrap);
  });

  // accordion toggle
  box.querySelectorAll(".acc-head").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const parent = btn.closest(".acc-item");
      parent.classList.toggle("open");
    });
  });
}

function readFilterState(){
  const st={};
  FILTER_DEFS.forEach(def=>{
    const wrap=document.getElementById("chk_"+def.key);
    if(!wrap) return;
    const selected = Array.from(wrap.querySelectorAll("input:checked")).map(i=>i.value);
    st[def.key] = selected;
  });
  return st;
}

function writeCounts(){
  FILTER_DEFS.forEach(def=>{
    const st = readFilterState();
    const sel = st[def.key] || [];
    const el = document.getElementById("cnt_"+def.key);
    if(!el) return;
    if(sel.length){
      el.textContent = `${sel.length} seÃ§ili`;
      el.hidden = false;
    }else{
      el.hidden = true;
    }
  });
}

function applyFiltersToData(baseRows){
  const st = readFilterState(); const colmap={}; const sample=baseRows[0]||{};
  FILTER_DEFS.forEach(def=>{ colmap[def.key]=findCol(sample, def.matches); });
  return baseRows.filter(r=>{
    for(const def of FILTER_DEFS){
      const sel = st[def.key]; if(!sel || !sel.length) continue;
      const col = colmap[def.key]; if(!col) continue;
      if(!sel.includes(r[col])) return false;
    }
    return true;
  });
}

/* SeÃ§imlere gÃ¶re diÄŸer filtrelerin seÃ§eneklerini daralt (cascading) */
function updateFilterOptions(){
  const rows = applyFiltersToData(ALL);
  FILTER_DEFS.forEach(def=>{
    const wrap=document.getElementById("chk_"+def.key);
    if(!wrap) return;
    const col = findCol(rows[0]||{}, def.matches) || findCol(ALL[0]||{}, def.matches);
    if(!col) return;
    const visibleVals = new Set(rows.map(r=>r[col]).filter(v=>v));
    wrap.querySelectorAll("label.chkopt").forEach(lbl=>{
      const val = lbl.querySelector("input").value;
      lbl.style.display = visibleVals.has(val) ? "flex" : "none";
    });
  });
}

/* =================== RENDER =================== */
function applyAll(){
  let rows = applyFiltersToData(ALL);
  const q = document.getElementById("q").value.toLowerCase().trim();
  if(q){ rows = rows.filter(r => Object.values(r).some(v => (v??"").toString().toLowerCase().includes(q))); }
  VIEW = rows; PAGE = 1;
  renderAll();
  writeCounts();
  updateFilterOptions();
}

function renderAll(){ renderKPIs(); renderCharts(); renderList(); renderPagination(); }

function sumByKeySmart(rows, want){
  return rows.reduce((acc,r)=>{
    const key = Object.keys(r).find(k => normalizeKey(k).includes(want));
    return key ? acc + cleanNumber(r[key]) : acc;
  },0);
}

function renderKPIs(){
  const rows = VIEW;
  const maliyet = sumByKeySmart(rows,"MALÄ°YET");
  const toplamHarcama = sumByKeySmart(rows,"TOPLAM HARCAMA");
  const revize = sumByKeySmart(rows,"REVÄ°ZE Ã–DENEK");
  const har2025 = sumByKeySmart(rows,"2025 YILI HARCAMASI");
  const hedef2025 = sumByKeySmart(rows,"2025 PERFORMANS HEDEF");
  const skey = rows[0] ? findSulamaKey(rows[0]) : null;
  const sulama = skey ? rows.reduce((a,r)=>a+cleanNumber(r[skey]),0) : 0;
  const bakiye = Math.max(revize - har2025, 0);

  document.getElementById("k_maliyet").textContent = fmt(maliyet)+" â‚º";
  document.getElementById("k_harcama").textContent = fmt(toplamHarcama)+" â‚º";
  document.getElementById("k_revize").textContent = fmt(revize)+" â‚º";
  document.getElementById("k_yiliharcama").textContent = fmt(har2025)+" â‚º";
  document.getElementById("k_bakiye").textContent = fmt(bakiye)+" â‚º";
  document.getElementById("k_hedef").textContent = fmt(hedef2025);
  document.getElementById("k_sulama").textContent = fmt(sulama);
}

function renderCharts() {
  const rows = VIEW;
  const rev = sumByKeySmart(rows, "REVÄ°ZE Ã–DENEK");
  const har = sumByKeySmart(rows, "2025 YILI HARCAMASI");
  const kalan = Math.max(rev - har, 0);
  const oran = rev ? Math.round((har / rev) * 100) : 0;

  if (barChart) barChart.destroy();
  if (donutChart) donutChart.destroy();

  // ğŸ“Š BAR GRAFÄ°K â€” BaÅŸlÄ±k Ã¼stte, deÄŸer alt satÄ±rda
  const barLabels = [
    `Revize Ã–denek\n(${fmt(rev)} â‚º)`,
    `2025 HarcamasÄ±\n(${fmt(har)} â‚º)`
  ];

  barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: barLabels,
      datasets: [{
        data: [rev, har],
        backgroundColor: ["#0b6954", "#4ab39a"]
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: "#345" } },
        x: {
          ticks: {
            color: "#123",
            font: { size: 12, weight: "bold" },
            callback: function(value, index) {
              const lbl = this.getLabelForValue(index);
              return lbl.split("\n");
            }
          }
        }
      }
    }
  });

  // ğŸ© DONUT GRAFÄ°K â€” Etiketler dilimin TAM Ä°Ã‡Ä°NDE, eÄŸimli, Ã§akÄ±ÅŸmasÄ±z
  donutChart = new Chart(document.getElementById("donutChart"), {
    type: "doughnut",
    plugins: [ChartDataLabels],
    data: {
      labels: ["Harcama", "Kalan"],
      datasets: [{
        data: [har, kalan],
        backgroundColor: ["#0b6954", "#ccebe0"],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        title: {
          display: true,
          text: `%${oran} GerÃ§ekleÅŸme`,
          color: "#0b6954",
          font: { size: 18, weight: "bold" }
        },
        datalabels: {
          color: "#000",
          font: { weight: "bold", size: 11 },
          anchor: "center",
          align: "center",
          offset: -30, // merkeze biraz daha yaklaÅŸ
          rotation: ctx => {
            // Etiket eÄŸimi: her dilimin orta aÃ§Ä±sÄ±na gÃ¶re
            const a = ctx.startAngle + (ctx.endAngle - ctx.startAngle) / 2;
            return (a * 180 / Math.PI) - 90;
          },
          formatter: (v, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            const percent = total ? (v / total) * 100 : 0;
            // KÃ¼Ã§Ã¼k dilimlerde gizle
            if (percent < 8) return "";
            return fmt(v) + " â‚º";
          }
        }
      },
      cutout: "70%"
    }
  });
}

function renderList() {
  const list = document.getElementById("list"); 
  list.innerHTML = "";
  const start = (PAGE - 1) * PAGE_SIZE; 
  const rows = VIEW.slice(start, start + PAGE_SIZE);

  rows.forEach(r => {
    const c = document.createElement("div"); 
    c.className = "card";

    const il = r["Ä°L ADI"] || r["Ä°LÄ°"] || "-";
    const yapim = r["YAPIM ÅEKLÄ°"] || r["YAPIM SEKLI"] || "-";
    const yuklenici = r["YÃœKLENÄ°CÄ°"] || "-";

    const rev = cleanNumber(r["REVÄ°ZE Ã–DENEK"]);
    const har = cleanNumber(r["2025 YILI HARCAMASI"]);
    const oran = rev > 0 ? Math.round((har / rev) * 100) : 0;

   c.innerHTML = `
  <h3>${r.__TITLE}</h3>
  <p><b>Ä°l:</b> ${il} â€¢ <b>YapÄ±m:</b> ${yapim}</p>
  <p>${yuklenici !== "-" ? yuklenici : ""}</p>
  <p>
    Rev.Ã–d.: ${fmt(r["REVÄ°ZE Ã–DENEK"])} â‚º â€¢ 
    YÄ±lÄ± Harc.: ${fmt(r["2025 YILI HARCAMASI"])} â‚º 
    <span style="color:#0b6954;font-weight:600;">(%${oran})</span>
  </p>
  <p style="margin-top:-4px;">Bakiye: <b>${fmt(cleanNumber(r["REVÄ°ZE Ã–DENEK"]) - cleanNumber(r["2025 YILI HARCAMASI"]))} â‚º</b></p>`;
c.onclick = () => showDetail(r);
list.appendChild(c);
});
}

function renderPagination() {
  const p = document.getElementById("pagination");
  p.innerHTML = "";

  const total = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
  if (total <= 1) { 
    p.style.display = "none"; 
    return; 
  }
  p.style.display = "flex";

  const makeBtn = (label, disabled, action) => {
    const b = document.createElement("button");
    b.textContent = label;
    b.disabled = disabled;
    b.onclick = action;
    return b;
  };

  // Ä°lk / Ã–nceki
  const first = makeBtn("â® Ä°lk", PAGE === 1, () => {
    PAGE = 1;
    renderList();
    renderPagination();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
  const prev  = makeBtn("â† Ã–nceki", PAGE === 1, () => {
    PAGE--;
    renderList();
    renderPagination();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Sayfa numaralarÄ± (maks 7)
  const maxVisible = 7;
  let start = Math.max(1, PAGE - Math.floor(maxVisible / 2));
  let end = Math.min(total, start + maxVisible - 1);
  if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);

  const nums = document.createElement("span");
  nums.className = "page-numbers";
  for (let i = start; i <= end; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === PAGE) {
      btn.style.background = "#0b6954";
      btn.style.color = "#fff";
      btn.style.fontWeight = "700";
    }
    btn.onclick = () => {
      PAGE = i;
      renderList();
      renderPagination();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
    nums.appendChild(btn);
  }

  // Sonraki / Son
  const next = makeBtn("Sonraki â†’", PAGE === total, () => {
    PAGE++;
    renderList();
    renderPagination();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
  const last = makeBtn("â­ Son", PAGE === total, () => {
    PAGE = total;
    renderList();
    renderPagination();
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // GÃ¶sterilen aralÄ±k bilgisi
  const from = (PAGE - 1) * PAGE_SIZE + 1;
  const to   = Math.min(PAGE * PAGE_SIZE, VIEW.length);
  const info = document.createElement("span");
  info.className = "info";
  info.textContent = `GÃ¶sterilen: ${from.toLocaleString('tr-TR')}â€“${to.toLocaleString('tr-TR')} / ${VIEW.length.toLocaleString('tr-TR')} â€¢ Sayfa ${PAGE}/${total}`;

  // Manuel sayfa giriÅŸi (Git:)
  const goWrap = document.createElement("span");
  goWrap.className = "goto-wrap";
  goWrap.innerHTML = `
    <label>Git:</label>
    <input type="number" id="gotoPage" min="1" max="${total}" value="${PAGE}">
    <button id="gotoBtn">Git</button>
  `;

  const input = goWrap.querySelector("input");
  const goBtn = goWrap.querySelector("button");

  const goAction = () => {
    let target = parseInt(input.value);
    if (isNaN(target) || target < 1) target = 1;
    if (target > total) target = total;
    PAGE = target;
    renderList();
    renderPagination();
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  input.addEventListener("keydown", e => { if (e.key === "Enter") goAction(); });
  goBtn.addEventListener("click", goAction);

  // SÄ±ralama
  p.appendChild(first);
  p.appendChild(prev);
  p.appendChild(nums);
  p.appendChild(next);
  p.appendChild(last);
  p.appendChild(info);
  p.appendChild(goWrap);
}

/* =================== DETAIL MODAL =================== */
function showDetail(row){
  document.getElementById("m_title").textContent = row.__TITLE || "-";
  const il = row["Ä°L ADI"]||row["Ä°LÄ°"]||"-";
  document.getElementById("m_sub").textContent = `Ä°l: ${il}`;

  const revize = cleanNumber(row["REVÄ°ZE Ã–DENEK"]);
  const har2025 = cleanNumber(row["2025 YILI HARCAMASI"]);
  const bakiye = Math.max(revize - har2025, 0);
  const toplamMaliyet = cleanNumber(row["YILI FÄ°YATLARIYLA TOPLAM MALÄ°YET"]);
  const toplamHarcama = cleanNumber(row["YILI FÄ°YATLARIYLA TOPLAM HARCAMA"]);
  const hedef2025 = cleanNumber(row["2025 PERFORMANS HEDEFÄ°"]);
  const sulKey = findSulamaKey(row);
  const sulama = sulKey ? cleanNumber(row[sulKey]) : 0;

  const yapim = row["YAPIM ÅEKLÄ°"]||row["YAPIM SEKLI"]||"-";
  const daire = row["Ä°ÅTEN SORUMLU DAÄ°RE BAÅKANLIÄI"]||"-";
  const dsikod = row["DSÄ° FAALÄ°YET KODU"]||row["DSI FAALÄ°YET KODU"]||"-";
  const aciklama = row["AÃ‡IKLAMA"]||"-";
  const finans = row["FÄ°NANS"]||row["FINANS"]||"-";
  const bolgeNo = row["BÄ°RÄ°M KODU"]||row["BÃ–LGE NO"]||"-";
  const bolgesel = row["BÃ–LGESEL DURUM"]||"-";
  const havza = row["HAVZA ADI"]||row["HAVZA"]||"-";

  const grid = document.getElementById("m_grid");
  grid.innerHTML = `
    ${cell("Faaliyet AdÄ±", row.__TITLE || "-")}
    ${cell("DSÄ° Faaliyet Kodu", dsikod)}
    ${cell("Ä°ÅŸten Sorumlu Daire", daire)}
    ${cell("YapÄ±m Åekli", yapim)}
    ${cell("BÃ¶lge No", bolgeNo)}
    ${cell("BÃ¶lgesel Durum", bolgesel)}
    ${cell("Havza", havza)}
    ${cell("Finans", finans)}
    ${cell("Toplam Maliyet", fmt(toplamMaliyet) + " â‚º")}
    ${cell("Toplam Harcama", fmt(toplamHarcama) + " â‚º")}
    ${cell("Revize Ã–denek", fmt(revize) + " â‚º")}
    ${cell("2025 YÄ±lÄ± HarcamasÄ±", fmt(har2025) + " â‚º")}
    ${cell("Bakiye", fmt(bakiye) + " â‚º")}
    ${cell("2025 Performans Hedefi", hedef2025 ? fmt(hedef2025) : "-")}
    ${cell("Sulama (ha)", sulama ? fmt(sulama) : "-")}
    ${cell("CSBB Proje AdÄ±", row["CSBB PROJE ADI"] || "-")}
    ${cell("CSBB PRJ NO (Yeni)", row["CSBB PRJ NO(YENÄ°)"] || row["CSBB PRJ NO (YENÄ°)"] || "-")}
    ${cell("Alt Faaliyet", row["ALT FAAL."] || row["ALT FAALIYET"] || "-")}
    ${cell("YÃ¼klenici", row["YÃœKLENÄ°CÄ°"] || "-")}
    ${cell("SÃ¶zleÅŸme Tarihi", row["SÃ–ZLEÅME TARÄ°HÄ°"] || "-")}
    ${cell("Ä°ÅŸe BaÅŸlama Tarihi", row["Ä°ÅE  BAÅLAMA TARÄ°HÄ°"] || "-")}
    ${cell("BitiÅŸ Tarihi", row[" BÄ°TÄ°Å TARÄ°HÄ°"] || "-")}
    ${cell("AÃ§Ä±klama", aciklama)}
  `;
  openModal();
}
function cell(label, value){
  return `<div class="m-card"><div class="l">${label}</div><div class="v">${value||"-"}</div></div>`;
}
function openModal(){
  const w=document.getElementById("detailWrap");
  w.style.display="flex"; w.setAttribute("aria-hidden","false");
}
function closeModal(){
  const w=document.getElementById("detailWrap");
  w.style.display="none"; w.setAttribute("aria-hidden","true");
}

/* =================== EVENTS =================== */
document.getElementById("q").addEventListener("input", applyAll);
document.getElementById("clearSearch").addEventListener("click",()=>{document.getElementById("q").value="";applyAll();});

document.getElementById("filterBtn").onclick = ()=>{
  document.getElementById("drawer").classList.add("open");
  document.getElementById("drawer").setAttribute("aria-hidden","false");
};
document.getElementById("closeDrawer").onclick = ()=>{
  document.getElementById("drawer").classList.remove("open");
  document.getElementById("drawer").setAttribute("aria-hidden","true");
};

document.getElementById("applyFilters").onclick = ()=>{
  saveFilters();
  applyAll();
  document.getElementById("drawer").classList.remove("open");
};
document.getElementById("clearFilters").onclick = ()=>{
  FILTER_DEFS.forEach(def=>{
    const wrap=document.getElementById("chk_"+def.key);
    if(wrap) wrap.querySelectorAll("input[type=checkbox]").forEach(i=>i.checked=false);
  });
  saveFilters(); applyAll();
};

document.getElementById("detailWrap").addEventListener("click",e=>{
  if(e.target.id==="detailWrap") closeModal();
});
document.getElementById("btnClose").onclick=closeModal;
document.addEventListener("keydown",e=>{ if(e.key==="Escape") closeModal(); });
document.getElementById("btnPrint").onclick=()=>window.print();

document.getElementById("rowsPerPage").addEventListener("change", (e) => {
  PAGE_SIZE = parseInt(e.target.value) || 100;
  PAGE = 1;                 // yeni sayfa boyutunda baÅŸa dÃ¶n
  renderList();
  renderPagination();
});


/* =================== PERSIST =================== */
function saveFilters(){ localStorage.setItem(memoryKey, JSON.stringify(readFilterState())); }
function restoreFilters(){
  const raw=localStorage.getItem(memoryKey); if(!raw) return;
  const st=JSON.parse(raw);
  FILTER_DEFS.forEach(def=>{
    const wrap=document.getElementById("chk_"+def.key);
    if(wrap && Array.isArray(st[def.key])){
      st[def.key].forEach(v=>{
        const el = wrap.querySelector(`input[value="${CSS.escape(v)}"]`);
        if(el) el.checked = true;
      });
    }
  });
  writeCounts();
}

/* =================== GO! =================== */
load();
</script>
</body>
</html>
